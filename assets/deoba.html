<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoonSec v3 Deobfuscator</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #1e1e1e; color: #d4d4d4; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; }
        .container { display: flex; flex-grow: 1; gap: 20px; }
        .panel { flex: 1; display: flex; flex-direction: column; background-color: #252526; border: 1px solid #3e3e42; border-radius: 8px; overflow: hidden; }
        .panel-header { background-color: #2d2d30; padding: 10px 15px; font-weight: bold; border-bottom: 1px solid #3e3e42; }
        textarea { flex-grow: 1; padding: 15px; border: none; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 14px; resize: none; outline: none; }
        .controls { margin-bottom: 20px; text-align: center; }
        button { background-color: #007acc; color: white; border: none; padding: 12px 25px; font-size: 16px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #005a9e; }
        button:disabled { background-color: #555; cursor: not-allowed; }
        .log { height: 150px; background-color: #252526; border: 1px solid #3e3e42; border-radius: 8px; padding: 10px; margin-top: 20px; overflow-y: auto; font-family: 'Consolas', 'Monaco', monospace; font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>MoonSec v3 Deobfuscator</h1>
    <div class="controls"><button id="deobfuscateBtn">Deobfuscate Script</button></div>
    <div class="container">
        <div class="panel"><div class="panel-header">Obfuscated Input</div><textarea id="inputScript" placeholder="Paste your MoonSec v3 obfuscated Lua script here..."></textarea></div>
        <div class="panel"><div class="panel-header">Deobfuscated Output</div><textarea id="outputScript" readonly placeholder="The deobfuscated script will appear here..."></textarea></div>
    </div>
    <div id="log" class="log">Log output will appear here...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/fengari-web/0.1.4/fengari-web.js"></script>
    <script>
        const deobfuscateBtn = document.getElementById('deobfuscateBtn');
        const inputScript = document.getElementById('inputScript');
        const outputScript = document.getElementById('outputScript');
        const logDiv = document.getElementById('log');

        function log(message) { logDiv.textContent += message + '\n'; logDiv.scrollTop = logDiv.scrollHeight; }

        deobfuscateBtn.addEventListener('click', () => {
            const obfuscatedCode = inputScript.value;
            if (!obfuscatedCode.trim()) { log('[ERROR] Input script is empty.'); return; }
            deobfuscateBtn.disabled = true; logDiv.textContent = ''; outputScript.value = '';
            log('[INFO] Starting deobfuscation...');

            try {
                const luaState = fengari.lauxlib.luaL_newstate();
                fengari.lualib.luaL_openlibs(luaState);

                // Capture prints from the Lua script into a JS array
                const capturedStrings = [];
                fengari.lua.lua_pushjsfunction(luaState, function(L) {
                    const output = fengari.lua.lua_tojsstring(L, 1);
                    capturedStrings.push(output);
                    return 0;
                });
                fengari.lua.lua_setglobal(luaState, "print");

                // Execute the script to populate the environment
                const status = fengari.lauxlib.luaL_dostring(luaState, obfuscatedCode);
                if (status !== fengari.lua.LUA_OK) {
                    const errorMsg = fengari.lua.lua_tojsstring(luaState, -1);
                    log(`[ERROR] Lua execution failed: ${errorMsg}`);
                    fengari.lua.lua_close(luaState);
                    deobfuscateBtn.disabled = false;
                    return;
                }
                log('[INFO] Script executed. Global environment populated.');

                // --- CORE DEOBFUSCATION LOGIC ---
                let deobfuscatedCode = obfuscatedCode;
                log('[INFO] Starting pattern replacement...');

                // 1. Replace simple string table calls: string_table[123]
                // This regex finds patterns like someVar[123] and replaces them if the string was captured.
                const stringTableRegex = /(\w+)$$(\d+)$$/g;
                deobfuscatedCode = deobfuscatedCode.replace(stringTableRegex, (match, tableName, index) => {
                    const stringIndex = parseInt(index, 10);
                    if (capturedStrings[stringIndex] !== undefined) {
                        log(`[REPLACE] Found string table call: ${match} -> "${capturedStrings[stringIndex]}"`);
                        return `"${capturedStrings[stringIndex]}"`;
                    }
                    return match; // No replacement found
                });

                // 2. Replace function calls: someFunc(123, "arg")
                // This is more complex. For a real tool, you'd parse the AST.
                // This regex is a simplified approach.
                const functionCallRegex = /(\w+)\s*$$\s*(\d+)\s*(?:,\s*["']([^^"']+)["']\s*)?$$/g;
                deobfuscatedCode = deobfuscatedCode.replace(functionCallRegex, (match, funcName, numIndex, strArg) => {
                    const funcIndex = parseInt(numIndex, 10);
                    // Check if this function name corresponds to a known deobfuscator function
                    // In MoonSec, often a single function handles all string/bytecode decoding.
                    // Let's assume if we call the function with the index, we get the string back.
                    // We'll try to call it in our Lua state.
                    fengari.lua.lua_getglobal(luaState, funcName);
                    fengari.lua.lua_pushjsstring(luaState, numIndex);
                    if (strArg) {
                        fengari.lua.lua_pushjsstring(luaState, strArg);
                    }
                    const callStatus = fengari.lua.lua_pcallk(luaState, strArg ? 2 : 1, 1, 0, 0, null);

                    if (callStatus === fengari.lua.LUA_OK) {
                        const result = fengari.lua.lua_tojsstring(luaState, -1);
                        fengari.lua.lua_pop(luaState, 1); // Pop result
                        if (result) {
                            log(`[REPLACE] Found function call: ${match} -> "${result}"`);
                            return `"${result}"`;
                        }
                    } else {
                        fengari.lua.lua_pop(luaState, 1); // Pop error message
                    }
                    return match; // No replacement found
                });

                // 3. Clean up common obfuscator artifacts
                log('[INFO] Cleaning up garbage code...');
                deobfuscatedCode = deobfuscatedCode.replace(/local\s+\w+\s*=\s*function$$$$\s*return\s*function$$$$\s*end\s*end/g, ''); // Dummy wrappers
                deobfuscatedCode = deobfuscatedCode.replace(/;\s*end;?\s*end/g, '; end'); // Extra ends
                deobfuscatedCode = deobfuscatedCode.replace(/do\s+end\s*/g, ''); // Empty do blocks
                
                log('[SUCCESS] Deobfuscation complete.');
                outputScript.value = deobfuscatedCode;
                fengari.lua.lua_close(luaState);

            } catch (e) {
                log(`[CRITICAL ERROR] JavaScript Exception: ${e.message}`);
            } finally {
                deobfuscateBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
